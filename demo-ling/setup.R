library(mfdb)
library(tidyverse)
library(gadget3)


year_range <- 1982:lubridate::year(Sys.Date())
read_data <- FALSE

reitmapping <- 
  read.table(
    system.file("demo-data", "reitmapping.tsv", package="mfdb"),
    header=TRUE,
    as.is=TRUE)

defaults <- list(
  area = mfdb_group("1" = unique(reitmapping$SUBDIVISION)),
  timestep = mfdb_timestep_quarterly,
  year = year_range,
  species = 'LIN')

time <-  g3a_time(start_year = min(defaults$year), 
                  end_year = max(defaults$year), 
                  defaults$timestep)
bootstrap <- FALSE

areas <- structure(
    seq_along(defaults$area),
    names = names(defaults$area))

# Setup up the model blue print
## modelled stocks

ling_imm <- 
  g3_stock('ling_imm', seq(20, 156, 4)) %>%
  g3s_livesonareas(areas[c('1')]) %>%
  g3s_age(3, 10)

ling_mat <- 
  g3_stock('ling_mat', seq(20, 156, 4)) %>%
  g3s_livesonareas(areas[c('1')]) %>%
  g3s_age(5, 15)

## fleets

lln <- 
  g3_fleet('lln') %>% 
  g3s_livesonareas(areas[c('1')])

bmt <- 
  g3_fleet('bmt') %>% 
  g3s_livesonareas(areas[c('1')])

gil <- 
  g3_fleet('gil') %>% 
  g3s_livesonareas(areas[c('1')]) 

foreign <- 
  g3_fleet('foreign') %>% 
  g3s_livesonareas(areas[c('1')])

igfs <- 
  g3_fleet('igfs') %>% 
  g3s_livesonareas(areas[c('1')])


if(read_data){
  mdb<-mfdb('Iceland')
  source('demo-ling/setup-fleet-data.R')
  source('demo-ling/setup-catchdistribution.R')
  source('demo-ling/setup-indices.R')
  source('demo-ling/setup-initial_parameters.R')
} else {
  fs::dir_ls('data') %>% 
    stringr::str_subset('.Rdata') %>% 
    lapply(load,.GlobalEnv)
}

source('demo-ling/setup-fleets.R')
source('demo-ling/setup-model.R')
source('demo-ling/setup-likelihood.R')

## set up reporting:

imm_report <- g3s_clone(ling_imm, 'imm_report') %>%
  g3s_time(year = local(year_range), step = 1:4)

mat_report <- g3s_clone(ling_mat, 'mat_report') %>%
  g3s_time(year = local(year_range), step = 1:4)

ling_model <- g3_to_r(c(
  ling_mat_actions,
  ling_imm_actions,
  fleet_actions,
  ling_likelihood_actions,
  list(gadget3:::g3a_report_stock(imm_report,ling_imm, ~stock_ss(ling_imm__num)),
       gadget3:::g3a_report_stock(mat_report,ling_mat, ~stock_ss(ling_mat__num)),
       gadget3:::g3a_report_stock(imm_report,ling_imm, ~stock_ss(ling_imm__wgt)),
       gadget3:::g3a_report_stock(mat_report,ling_mat, ~stock_ss(ling_mat__wgt)),
       gadget3:::g3a_report_stock(mat_report,ling_mat, ~stock_ss(ling_mat__igfs)),
       gadget3:::g3a_report_stock(imm_report,ling_imm, ~stock_ss(ling_imm__igfs)),
       gadget3:::g3a_report_stock(mat_report,ling_mat, ~stock_ss(ling_mat__bmt)),
       gadget3:::g3a_report_stock(imm_report,ling_imm, ~stock_ss(ling_imm__bmt)),
       gadget3:::g3a_report_stock(mat_report,ling_mat, ~stock_ss(ling_mat__lln)),
       gadget3:::g3a_report_stock(imm_report,ling_imm, ~stock_ss(ling_imm__lln)),
       gadget3:::g3a_report_stock(mat_report,ling_mat, ~stock_ss(ling_mat__gil)),
       gadget3:::g3a_report_stock(imm_report,ling_imm, ~stock_ss(ling_imm__gil)),
       gadget3:::g3a_report_stock(mat_report,ling_mat, ~stock_ss(ling_mat__foreign)),
       gadget3:::g3a_report_stock(imm_report,ling_imm, ~stock_ss(ling_imm__foreign))),
  list(time)))


tmb_ling <- g3_to_tmb(c(
  ling_mat_actions,
  ling_imm_actions,
  fleet_actions,
  ling_likelihood_actions,
  list(time)))


## update the input parameters with sane initial guesses
tmb_param <- attr(tmb_ling, 'parameter_template')

## I would like to do something like this:
if(FALSE){
  read.gadget.parameters(sprintf('%s/params.out',gd)) %>% 
    init_guess('rec.[0-9]|init.[0-9]',1,0.001,1000,1) %>%
    init_guess('recl',12,1,20,1) %>% 
    init_guess('rec.sd',5, 4, 20,1) %>% 
    init_guess('Linf',160, 100, 200,1) %>% 
    init_guess('k$',90, 40, 100,1) %>% 
    init_guess('bbin',6, 1e-08, 100, 1) %>% 
    init_guess('alpha', 0.5,  0.01, 3, 1) %>% 
    init_guess('l50',50,10,100,1) %>% 
    init_guess('walpha',lw.constants$estimate[1], 1e-10, 1,0) %>% 
    init_guess('wbeta',lw.constants$estimate[2], 2, 4,0) %>% 
    init_guess('M$',0.15,0.001,1,0) %>% 
    init_guess('rec.scalar',400,1,500,1) %>% 
    init_guess('init.scalar',200,1,300,1) %>% 
    init_guess('mat2',mat.l50$l50,0.75*mat.l50$l50,1.25*mat.l50$l50,1) %>% 
    init_guess('mat1',70,  10, 200, 1) %>% 
    init_guess('init.F',0.4,0.1,1,1) %>% 
    init_guess('p0',0,0,1,1) %>% 
    init_guess('p2',1,0,1,1) %>% 
    init_guess('p3',1,0.01,100,1) %>% 
    init_guess('p4',1,0.01,100,1) %>% 
    init_guess('mode',70,30,90,1) %>% 
    write.gadget.parameters(.,file=sprintf('%s/params.in',gd))
}

## but lets settle for 
param_names <- rownames(tmb_param)



ling_param <- list(  # ./06-ling/12-new_ass/params.in
  "ling.Linf" = 160,
  "ling.k" = 90,
  "lingimm.walpha" = 2.27567436711055e-06,
  "lingimm.wbeta" = 3.20200445996187,
  "ling.bbin" = 6,
  "lingimm.M" = rep(0.15,10),
  "lingimm.init.scalar" = 200,
  "ling.init.F" = 0.4,
  "lingimm.init" = rep(1, 10 - 3 + 1),
  "ling.recl" = 12,
  "ling.mat1" = 70,
  "ling.mat2" = 75,
  "ling.rec.scalar" = 400,
  "ling.rec.1982" = 1,
  "ling.rec.sd" = 5,
  "ling.rec" = rep(1, 2020 - 1981 + 1),
  "lingmat.M" = rep(0.15,15),
  "lingmat.init.scalar" = 200,
  "lingmat.init" = rep(1, 15 - 5 + 1),
  "lingmat.walpha" = 2.27567436711055e-06,
  "lingmat.wbeta" = 3.20200445996187,
  "ling.igfs.alpha" = 0.5,
  "ling.igfs.l50" = 50,
  "ling.lln.alpha" = 0.5,
  "ling.lln.l50" = 50,
  "ling.bmt.alpha" = 0.5,
  "ling.bmt.l50" = 50,
  "ling.gil.alpha" = 0.5,
  "ling.gil.l50" = 50,
  "ling.init.sd" = init.sigma$ms,
  "ling_si_alpha1" = 6.4e-9,
  "ling_si_beta1" = 1.4,
  'ling_si_alpha2' = 1.7e-7,
  "ling_si_beta2" = 1.3,
  'ling_si_alpha3' = 2.7e-5,
  'ling_si_alpha4' = 4.2e-5,
  'ling_si_alpha5' = 5.4e-5,
  'ling_si_alpha6' = 5.8e-5,
  'ling_si_alpha7' = 7.1e-5,
  end = NULL)

#ling_model <- edit(ling_model)
result <- ling_model(ling_param)
environment(ling_model)$model_report -> tmp

tmb_param$value <- I(ling_param[rownames(tmb_param)])
tmb_param$lower <- vapply(tmb_param$value, function (x) 0.5 * x[[1]], numeric(1))
tmb_param$upper <- vapply(tmb_param$value, function (x) 2 * x[[1]], numeric(1))

tmb_param['ling.rec',]$lower <- 0.0001
tmb_param['ling.rec',]$upper <- 1e3
tmb_param['lingmat.init',]$lower <- 0.0001
tmb_param['lingmat.init',]$upper <- 1e3

tmb_param['lingimm.init',]$lower <- 0.0001
tmb_param['lingimm.init',]$upper <- 1e3


tmb_param[c('lingimm.M',
            'lingmat.M',
            'ling.init.sd',
            'lingimm.walpha',
            'lingimm.wbeta',
            'lingmat.walpha',
            'lingmat.wbeta',
            "ling_si_alpha1",
            "ling_si_beta1" ,
            'ling_si_alpha2',
            "ling_si_beta2" ,
            'ling_si_alpha3',
            'ling_si_alpha4',
            'ling_si_alpha5',
            'ling_si_alpha6',
            'ling_si_alpha7'),]$optimise <- FALSE


ling_model_tmb <- g3_tmb_adfun(tmb_ling,tmb_param)

ling_model_tmb$fn(g3_tmb_par(tmb_param))

#params <- 
#  tibble(switch = names(par), value = par, upper = 2*par, lower = 0.5*par, optimise = 0*par + 1, order = 1:length(par)) #%>% 
# Rgadget::init_guess('M[0-9+]$',optimise = 0) %>% 
# Rgadget::init_guess('__sd[0-9+]$',optimise = 0) %>% 
# Rgadget::init_guess('si_alpha[0-9+]$',optimise = 0) %>% 
# Rgadget::init_guess('si_beta[0-9]$',optimise = 0) %>% 
# arrange(order)
#%>% 
#  mutate(upper = ifelse(optimise == 0, 1.01*value,upper),
#         lower = ifelse(optimise == 0, 0.99*value,lower))

fit <- nlminb(g3_tmb_par(tmb_param), 
              ling_model_tmb$fn, ling_model_tmb$gr, 
              upper = g3_tmb_upper(tmb_param),
              lower = g3_tmb_lower(tmb_param),
              control = list(trace = TRUE, eval.max=2000, iter.max=1000))
#control = list(abs.tol = 1e-20,xf.tol = 0.1)) 
fit2 <- nlminb(fit$par, 
               ling_model_tmb$fn, ling_model_tmb$gr,
               upper = g3_tmb_upper(tmb_param),
               lower = g3_tmb_lower(tmb_param),
               control = list(trace = TRUE))
fit3 <- nlminb(fit3$par, 
               ling_model_tmb$fn, ling_model_tmb$gr,
               upper = g3_tmb_upper(tmb_param),
               lower = g3_tmb_lower(tmb_param),
               control = list(trace = TRUE, eval.max=2000, iter.max=1000))
